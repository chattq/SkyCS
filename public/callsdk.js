function updateUI(){}const eventHandlers={},_SipPhone={data:null,phone:null,incomingCallAudio:null,phoneStatus:{isOnline:!1},session:null,callOptions:{eventHandlers:eventHandlers,mediaConstraints:{audio:!0,video:!1}},callNotify(){var n=function(n){var e=document.getElementById("audio_ring");e||((e=document.createElement("span")).setAttribute("id","audio_ring"),document.body.appendChild(e)),e.innerHTML='<audio autoplay loop><source src="/audio/ring.wav"></audio>',new Notification("Skycs",{body:"Cuộc gọi đến",icon:"/images/icons/logo.png"}).onclick=function(n){window.focus(),this.close()}};if(!("Notification"in window))return alert("This browser does not support Desktop notifications");if("granted"===Notification.permission)return n();if("denied"!==Notification.permission){Notification.requestPermission(e=>{if("granted"===e)return n()});return}},stopRinging(){var n=document.getElementById("audio_ring");n&&(n.innerHTML="")},init:function(n,e,o){this.data=n;var i={sockets:[new JsSIP.WebSocketInterface(`${n.Protocol}://${n.Server}`)],uri:`sip:${n.ExtId}@${n.ExtDomain}`,password:`${n.ExtSecret}`,username:`${n.ExtId}`,register:!0,iceServers:[{urls:"stun:stun.l.google.com:19302"}]};this.phoneStatus.extension=n.ExtId,this.incomingCallAudio=new window.Audio("/ring.wav"),this.incomingCallAudio.loop=!0,this.incomingCallAudio.crossOrigin="anonymous",JsSIP.debug.disable(),this.phone=new JsSIP.UA(i),this.remoteAudio=new window.Audio,this.remoteAudio.autoplay=!0,this.remoteAudio.crossOrigin="anonymous",this.phone.on("registered",function(n){e&&e(),window._onPhoneRegistered&&window._onPhoneRegistered(),_SipPhone.phoneStatus.isOnline=!0,Notification?"granted"!==Notification.permission&&Notification.requestPermission():alert("Desktop notifications not available in your browser. Try Chromium.")}),this.phone.on("disconnected",function(n){window._onPhoneUnregistered&&window._onPhoneUnregistered(),_SipPhone.phoneStatus.isOnline=!1}),this.phone.on("unregistered",function(n){window._onPhoneUnregistered&&window._onPhoneUnregistered()}),this.phone.on("registrationFailed",function(n){console.log("Registering on SIP server failed with error: "+n.cause),i.uri=null,i.password=null,o&&o()}),this.phone.on("newRTCSession",function(n){var e=n.session;_SipPhone.session&&!_SipPhone.session.isEnded()&&_SipPhone.session.terminate(),_SipPhone.session=e;var o=function(){console.log("ended",_SipPhone.session),window._onStateChanged({state:"ended",direction:_SipPhone.session.direction}),_SipPhone.stopRinging()},i=function(n){var e=n;"accept"===n&&(e="incall"),"confirmed"===n&&(e="incall");var o=_SipPhone.session,i=_SipPhone.session.remote_identity.uri.user,s=_SipPhone.session.local_identity.uri.user;if("outgoing"==o.direction){var t=s;s=i,i=t}o&&window._onStateChanged({state:e,direction:o.direction,fromNumber:i,toNumber:s})};if(_SipPhone.session.on("ended",o),_SipPhone.session.on("failed",o),_SipPhone.session.on("accepted",function(){i("accepted")}),_SipPhone.session.on("confirmed",function(){var n=_SipPhone.session.connection.getLocalStreams()[0],e=_SipPhone.session.connection.createDTMFSender(n.getAudioTracks()[0]);_SipPhone.session.sendDTMF=function(n){e.insertDTMF(n)},i("confirmed")}),_SipPhone.session.on("peerconnection",n=>{console.log("peerconnection",n);let e=n.peerconnection;e.onaddstream=function(n){console.log("addstream",n),_SipPhone.remoteAudio.srcObject=n.stream,_SipPhone.remoteAudio.play(),_SipPhone.stopRinging()};var o=new MediaStream;console.log(e.getReceivers()),e.getReceivers().forEach(function(n){console.log(n),o.addTrack(n.track)})}),"incoming"===_SipPhone.session.direction){console.log(_SipPhone.session),i("ringing");try{_SipPhone.callNotify()}catch(s){console.log("sound error",s.message)}}else i("calling"),_SipPhone.session.connection.addEventListener("addstream",function(n){console.log("addstream",_SipPhone.session);try{_SipPhone.stopRinging()}catch(e){}_SipPhone.remoteAudio.srcObject=n.stream})})},connect:function(){return this.phone&&this.phone.start()},disconnect:function(){try{_SipPhone.session&&(_SipPhone.session.terminate(),_SipPhone.session=null)}catch(n){console.log(n)}return this.phone&&this.phone.stop()},dial:function(n,e){e?this.phone.call(n,{eventHandlers:{confirmed(){e()}},mediaConstraints:{audio:!0,video:!1}}):this.phone.call(n,this.callOptions)},answer:function(){this.session.answer(this.callOptions)},hold:function(){this.session.hold()},unhold:function(){this.session.unhold()},mute:function(){this.session.mute()},unmute:function(){this.session.unmute()},sendDTMF:function(n){this.session.sendDTMF(n)},showForward:function(n){window._onShowforward(n)},hangup:function(){try{console.log("hanging up",_SipPhone.session),window._onStateChanged({state:"ended",direction:""}),_SipPhone.session&&!_SipPhone.session.isEnded()&&_SipPhone.session.terminate()}catch(n){console.log(n)}try{_SipPhone.stopRinging()}catch(e){console.log("sound error",e)}this.session=null},onStateChanged(n){window._onStateChanged=n},onShowforward(n){window._onShowforward=n},onRegistered(n){window._onPhoneRegistered=n},onUnregistered(n){window._onPhoneUnregistered=n}};window.Phone=_SipPhone,window.addEventListener("beforeunload",function(n){_SipPhone.disconnect()});